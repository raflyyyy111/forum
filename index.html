<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P2P Chat [v9 - Professional Engine]</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
    <style>
        :root {
            --bg-color: #0D0D0D;
            --text-color: #00FF41;
            --accent-color: #33FF77;
            --meta-color: #888888;
            --error-color: #FF4136;
            --font-family: 'Consolas', 'Menlo', 'Courier New', monospace;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            margin: 0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            border: 1px solid var(--accent-color);
            padding: 1rem;
        }
        #messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            word-wrap: break-word;
        }
        .message { margin-bottom: 0.5rem; }
        .message .sender { font-weight: bold; color: var(--accent-color); }
        .message.system .content { color: var(--meta-color); font-style: italic; }
        .message.error .content { color: var(--error-color); font-style: italic; }
        #input-container { display: flex; }
        #chat-input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            border-bottom: 1px solid var(--accent-color);
            color: var(--text-color);
            font-family: var(--font-family);
            font-size: 1rem;
            padding: 0.5rem;
            outline: none;
        }
        #chat-input:focus { border-bottom-color: var(--text-color); }
        #send-button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 0.5rem 1rem;
            margin-left: 1rem;
            cursor: pointer;
            font-family: var(--font-family);
            font-weight: bold;
        }
        #initial-screen { text-align: center; padding-top: 20vh; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="initial-screen">
        <h1>Welcome to Anonymous P2P Chat</h1>
        <p>To start or join a chat room, add a name to the URL hash.</p>
        <p>Example: <strong>your-url.com/#my-secret-room</strong></p>
    </div>

    <div id="chat-container" class="hidden">
        <div id="messages"></div>
        <div id="input-container">
            <input type="text" id="chat-input" placeholder="Type message and press Enter...">
            <button id="send-button">SEND</button>
        </div>
    </div>

    <script>
        const roomName = window.location.hash.substring(1);
        if (!roomName) {
            document.getElementById('chat-container').classList.add('hidden');
            document.getElementById('initial-screen').classList.remove('hidden');
        } else {
            initializeChat(roomName);
        }

        function initializeChat(room) {
            const messagesDiv = document.getElementById('messages');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            document.getElementById('initial-screen').classList.add('hidden');
            document.getElementById('chat-container').classList.remove('hidden');

            const MQTT_BROKER = 'wss://broker.hivemq.com:8884/mqtt';
            const TOPIC = `webrtc-chat-v9/${room}`;
            
            const myPeerId = 'peer_' + Math.random().toString(36).substring(2, 11);
            const myUsername = 'User-' + Math.random().toString(36).substring(2, 6).toUpperCase();
            const peers = {}; // Menyimpan semua koneksi peer { peerId: simplePeerInstance }
            let mqttClient = null;

            const addMessage = (text, sender = "System", type = "system") => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${type}`;
                const senderSpan = sender ? `<span class="sender">${sender}: </span>` : '';
                msgDiv.innerHTML = `${senderSpan}<span class="content">${text}</span>`;
                messagesDiv.appendChild(msgDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            };

            const connectToSignaling = () => {
                addMessage(`Connecting to signaling network...`);
                mqttClient = mqtt.connect(MQTT_BROKER);

                mqttClient.on('connect', () => {
                    addMessage(`Connected! Joining room: #${room}`);
                    mqttClient.subscribe(TOPIC, (err) => {
                        if (!err) {
                            // Kirim sinyal 'join' ke semua orang
                            sendSignal({ type: 'join' });
                            addMessage(`You joined as ${myUsername}.`);
                        }
                    });
                });

                mqttClient.on('message', (topic, message) => {
                    const data = JSON.parse(message.toString());
                    if (data.sender === myPeerId) return;

                    // Jika ada peer baru join, dan kita adalah 'inisiator', mulai koneksi
                    if (data.type === 'join' && myPeerId > data.sender) {
                        createPeer(data.sender, true);
                    }
                    // Jika kita menerima sinyal dari peer lain, teruskan ke simple-peer
                    if (data.type === 'signal' && data.target === myPeerId) {
                        if (peers[data.sender]) {
                            peers[data.sender].signal(data.signal);
                        } else {
                            // Jika kita belum punya koneksi, buat sebagai non-inisiator
                            createPeer(data.sender, false);
                            peers[data.sender].signal(data.signal);
                        }
                    }
                });

                mqttClient.on('error', (err) => addMessage(`Signaling error: ${err.message}`, "System", "error"));
            };

            const createPeer = (peerId, isInitiator) => {
                if (peers[peerId]) return;
                
                addMessage(`Establishing secure connection with a new peer...`);
                const peer = new SimplePeer({
                    initiator: isInitiator,
                    trickle: false, // Ini menyederhanakan proses sinyal secara drastis
                });

                peer.on('signal', (signal) => {
                    sendSignal({ type: 'signal', signal, target: peerId });
                });

                peer.on('connect', () => {
                    addMessage(`âœ… Secure P2P connection established!`);
                    peer.send(JSON.stringify({ type: 'handshake', username: myUsername }));
                });

                peer.on('data', (data) => {
                    const msg = JSON.parse(data.toString());
                    if (msg.type === 'handshake') {
                        addMessage(`Peer identified as '${msg.username}'.`);
                    } else if (msg.type === 'chat') {
                        addMessage(msg.text, msg.username, 'user');
                    }
                });

                peer.on('close', () => {
                    addMessage(`Connection with a peer was closed.`);
                    delete peers[peerId];
                });

                peer.on('error', (err) => {
                    addMessage(`Connection error: ${err.message}`, "System", "error");
                    if (peers[peerId]) {
                       peers[peerId].destroy();
                       delete peers[peerId];
                    }
                });

                peers[peerId] = peer;
            };

            const sendSignal = (data) => {
                const payload = { ...data, sender: myPeerId };
                mqttClient.publish(TOPIC, JSON.stringify(payload));
            };

            const broadcastMessage = (text) => {
                addMessage(text, myUsername, 'user');
                const message = { type: 'chat', username: myUsername, text: text };
                const payload = JSON.stringify(message);
                Object.values(peers).forEach(peer => {
                    if (peer.connected) {
                        peer.send(payload);
                    }
                });
            };
            
            window.addEventListener('beforeunload', () => {
                // simple-peer akan otomatis menutup koneksi, kita hanya perlu keluar dari MQTT
                if (mqttClient) mqttClient.end();
            });

            sendButton.addEventListener('click', () => {
                if (chatInput.value) {
                    broadcastMessage(chatInput.value);
                    chatInput.value = '';
                }
            });

            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && chatInput.value) {
                    e.preventDefault();
                    broadcastMessage(chatInput.value);
                    chatInput.value = '';
                }
            });

            connectToSignaling();
        }
    </script>
</body>
</html>
